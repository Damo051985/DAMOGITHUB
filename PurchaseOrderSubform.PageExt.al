PageExtension 50119 pageextension50119 extends "Purchase Order Subform" 
{

    //Unsupported feature: Property Insertion (RefreshOnActivate) on ""Purchase Order Subform"(Page 54)".

    layout
    {
        modify(Type)
        {
            StyleExpr = g_ColorFront;
        }
        modify("No.")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Cross-Reference No.")
        {
            StyleExpr = g_ColorFront;
        }
        modify("IC Partner Code")
        {
            StyleExpr = g_ColorFront;
        }
        modify("IC Partner Ref. Type")
        {
            StyleExpr = g_ColorFront;
        }
        modify("IC Partner Reference")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Variant Code")
        {
            StyleExpr = g_ColorFront;
        }
        modify(Nonstock)
        {
            StyleExpr = g_ColorFront;
        }
        modify("VAT Prod. Posting Group")
        {
            StyleExpr = g_ColorFront;
        }
        modify(Description)
        {
            StyleExpr = g_ColorFront;
        }
        modify("Drop Shipment")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Return Reason Code")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Location Code")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Bin Code")
        {
            StyleExpr = g_ColorFront;
        }
        modify(Quantity)
        {
            StyleExpr = g_ColorFront;
        }
        modify("Reserved Quantity")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Job Remaining Qty.")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Unit of Measure Code")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Unit of Measure")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Direct Unit Cost")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Indirect Cost %")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Unit Cost (LCY)")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Unit Price (LCY)")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Line Amount")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Line Discount %")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Line Discount Amount")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Prepayment %")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Prepmt. Line Amount")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Prepmt. Amt. Inv.")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Allow Invoice Disc.")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Inv. Discount Amount")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Qty. to Receive")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Quantity Received")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Qty. to Invoice")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Quantity Invoiced")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Prepmt Amt to Deduct")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Prepmt Amt Deducted")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Allow Item Charge Assignment")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Qty. to Assign")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Qty. Assigned")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Job No.")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Job Task No.")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Job Planning Line No.")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Job Line Type")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Job Unit Price")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Job Line Amount")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Job Line Discount Amount")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Job Line Discount %")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Job Total Price")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Job Unit Price (LCY)")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Job Total Price (LCY)")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Job Line Amount (LCY)")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Job Line Disc. Amount (LCY)")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Requested Receipt Date")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Promised Receipt Date")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Planned Receipt Date")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Expected Receipt Date")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Order Date")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Lead Time Calculation")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Planning Flexibility")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Prod. Order No.")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Prod. Order Line No.")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Operation No.")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Work Center No.")
        {
            StyleExpr = g_ColorFront;
        }
        modify(Finished)
        {
            StyleExpr = g_ColorFront;
        }
        modify("Whse. Outstanding Qty. (Base)")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Inbound Whse. Handling Time")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Blanket Order No.")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Blanket Order Line No.")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Appl.-to Item Entry")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Shortcut Dimension 1 Code")
        {
            StyleExpr = g_ColorFront;
        }
        modify("Shortcut Dimension 2 Code")
        {
            StyleExpr = g_ColorFront;
        }
        modify("ShortcutDimCode[3]")
        {
            StyleExpr = g_ColorFront;
        }
        modify("ShortcutDimCode[4]")
        {
            StyleExpr = g_ColorFront;
        }
        modify("ShortcutDimCode[5]")
        {
            StyleExpr = g_ColorFront;
        }
        modify("ShortcutDimCode[6]")
        {
            StyleExpr = g_ColorFront;
        }
        modify("ShortcutDimCode[7]")
        {
            StyleExpr = g_ColorFront;
        }
        modify("ShortcutDimCode[8]")
        {
            StyleExpr = g_ColorFront;
        }

        //Unsupported feature: Code Modification on "Type(Control 2).OnValidate".

        //trigger OnValidate()
        //Parameters and return type have not been exported.
        //>>>> ORIGINAL CODE:
        //begin
            /*
            NoOnAfterValidate;
            TypeChosen := HasTypeToFillMandatotyFields;

            IF xRec."No." <> '' THEN
              RedistributeTotalsOnAfterValidate;
            */
        //end;
        //>>>> MODIFIED CODE:
        //begin
            /*
            NoOnAfterValidate;
            TypeChosen := Type <> Type::" ";
            #3..5
            */
        //end;


        //Unsupported feature: Code Modification on ""No."(Control 4).OnValidate".

        //trigger "(Control 4)()
        //Parameters and return type have not been exported.
        //>>>> ORIGINAL CODE:
        //begin
            /*
            ShowShortcutDimCode(ShortcutDimCode);
            NoOnAfterValidate;

            IF xRec."No." <> '' THEN
              RedistributeTotalsOnAfterValidate;
            */
        //end;
        //>>>> MODIFIED CODE:
        //begin
            /*

            #1..4
            BEGIN
              RedistributeTotalsOnAfterValidate;
            END;
            // #009 <<
            RESValidate;
            {
            IF (PurchHeader."Reopen By" = '' ) AND (g_booRES = FALSE) AND (g_booWRExist = FALSE) AND (g_booPWRExist = FALSE) THEN
            BEGIN
              IF xRec."No." <> Rec."No." THEN
              BEGIN
                 g_recItem.RESET;
                 g_recItem.SETRANGE("No.", Rec."No.");
                 g_recItem.SETRANGE(Restricted, TRUE);
                 IF NOT g_recItem.ISEMPTY  THEN
                 BEGIN
                    ERROR('Restricted Item - %1 is not allow to input!', Rec."No.");
                    CurrPage.UPDATE(FALSE);
                    //EXIT;
                 END;
              END;
            END;
            }
            // #009 >>

            CalLastPurchasePrice(Rec,FALSE);//#003
            */
        //end;


        //Unsupported feature: Code Insertion on ""Location Code"(Control 74)".

        //trigger OnValidate()
        //Parameters and return type have not been exported.
        //begin
            /*
            // #009 <<
            RESValidate;
            // #009 >>
            */
        //end;


        //Unsupported feature: Code Modification on "Quantity(Control 8).OnValidate".

        //trigger OnValidate()
        //Parameters and return type have not been exported.
        //>>>> ORIGINAL CODE:
        //begin
            /*
            RedistributeTotalsOnAfterValidate;
            */
        //end;
        //>>>> MODIFIED CODE:
        //begin
            /*
            //#007 ->
            CLEAR(WhseValidateSourceLine);
            WhseValidateSourceLine.PurchaseLineVerifyChangeforLL(Rec,xRec);
            //#007 <-

            // #009 <<
            RESValidate;
            // #009 >>


            RedistributeTotalsOnAfterValidate;
            */
        //end;


        //Unsupported feature: Code Modification on ""Direct Unit Cost"(Control 12).OnValidate".

        //trigger OnValidate()
        //Parameters and return type have not been exported.
        //>>>> ORIGINAL CODE:
        //begin
            /*
            RedistributeTotalsOnAfterValidate;
            */
        //end;
        //>>>> MODIFIED CODE:
        //begin
            /*
            RedistributeTotalsOnAfterValidate;
            //#006<<
            GetCostTolerance(3);
            g_ColorFront:=GetStyleText("Direct Unit Cost");

            //#006>>
            // #009 <<
            RESValidate;
            // #009 >>

            //#007 ->
            CLEAR(WhseValidateSourceLine);
            WhseValidateSourceLine.PurchaseLineVerifyChangeforLL(Rec,xRec);
            //#007 <-
            */
        //end;


        //Unsupported feature: Code Modification on ""Line Amount"(Control 44).OnValidate".

        //trigger OnValidate()
        //Parameters and return type have not been exported.
        //>>>> ORIGINAL CODE:
        //begin
            /*
            RedistributeTotalsOnAfterValidate;
            */
        //end;
        //>>>> MODIFIED CODE:
        //begin
            /*
            //#007 ->
            CLEAR(WhseValidateSourceLine);
            WhseValidateSourceLine.PurchaseLineVerifyChangeforLL(Rec,xRec);
            //#007 <-


            RedistributeTotalsOnAfterValidate;
            */
        //end;


        //Unsupported feature: Code Modification on ""Line Discount %"(Control 16).OnValidate".

        //trigger OnValidate()
        //Parameters and return type have not been exported.
        //>>>> ORIGINAL CODE:
        //begin
            /*
            RedistributeTotalsOnAfterValidate;
            */
        //end;
        //>>>> MODIFIED CODE:
        //begin
            /*
            //#007 ->
            CLEAR(WhseValidateSourceLine);
            WhseValidateSourceLine.PurchaseLineVerifyChangeforLL(Rec,xRec);
            //#007 <-

            RedistributeTotalsOnAfterValidate;
            */
        //end;


        //Unsupported feature: Code Modification on ""Line Discount Amount"(Control 60).OnValidate".

        //trigger OnValidate()
        //Parameters and return type have not been exported.
        //>>>> ORIGINAL CODE:
        //begin
            /*
            RedistributeTotalsOnAfterValidate;
            */
        //end;
        //>>>> MODIFIED CODE:
        //begin
            /*
            //#007 ->
            CLEAR(WhseValidateSourceLine);
            WhseValidateSourceLine.PurchaseLineVerifyChangeforLL(Rec,xRec);
            //#007 <-

            RedistributeTotalsOnAfterValidate;
            */
        //end;

        //Unsupported feature: Property Deletion (AutoFormatExpr) on ""Invoice Discount Amount"(Control 35)".


        //Unsupported feature: Property Deletion (AutoFormatExpr) on ""Total Amount Excl. VAT"(Control 17)".


        //Unsupported feature: Property Deletion (AutoFormatExpr) on ""Total VAT Amount"(Control 15)".


        //Unsupported feature: Property Deletion (AutoFormatExpr) on ""Total Amount Incl. VAT"(Control 13)".



        //Unsupported feature: Code Modification on "RefreshTotals(Control 11).OnDrillDown".

        //trigger OnDrillDown()
        //>>>> ORIGINAL CODE:
        //begin
            /*
            DocumentTotals.PurchaseRedistributeInvoiceDiscountAmounts(Rec,VATAmount,TotalPurchaseLine);
            DocumentTotals.PurchaseUpdateTotalsControls(Rec,TotalPurchaseHeader,TotalPurchaseLine,RefreshMessageEnabled,
              TotalAmountStyle,RefreshMessageText,InvDiscAmountEditable,VATAmount);
            */
        //end;
        //>>>> MODIFIED CODE:
        //begin
            /*
            DocumentTotals.PurchaseRedistributeInvoiceDiscountAmounts(Rec,VATAmount,TotalPurchaseLine);
            CurrPage.UPDATE(FALSE);
            */
        //end;
        addfirst(Control1)
        {
            field("Line No.";"Line No.")
            {
                ApplicationArea = Basic;
                StyleExpr = g_ColorFront;
            }
        }
        addafter("No.")
        {
            field("LLMS Code";"LLMS Code")
            {
                ApplicationArea = Basic;
                StyleExpr = g_ColorFront;
                TableRelation = Item."LLMS Code";
                Visible = g_booLL;

                trigger OnLookup(var Text: Text): Boolean
                var
                    LLMSList: Page "LLMS Code List";
                    LLItem: Record Item;
                begin
                    //#004 ->
                    Clear(LLItem);
                    LLMSList.LookupMode(true);
                    if LLMSList.RunModal = Action::LookupOK then begin
                        LLMSList.GetRecord(LLItem);
                        if LLItem."LLMS Code" <> '' then begin
                            Validate("LLMS Code",LLItem."LLMS Code");
                        end else begin
                            Validate("No.",'');
                        end;
                    end;
                    //#004 <-
                end;

                trigger OnValidate()
                begin
                    CalLastPurchasePrice(Rec,false);//#003
                end;
            }
            field("Back to Back SO No.";"Back to Back SO No.")
            {
                ApplicationArea = Basic;
                Caption = 'SO No.';
                StyleExpr = g_ColorFront;
                Visible = g_booLL;
            }
            field("Last Stock-in Cost";"Last Stock-in Cost")
            {
                ApplicationArea = Basic;
                Editable = false;
                StyleExpr = g_ColorFront;
                Visible = g_booLL;
            }
            field(CalcPendOrderQty;CalcPendOrderQty)
            {
                ApplicationArea = Basic;
                Caption = 'Pending Order Qty';
                DecimalPlaces = 0:5;
                Enabled = false;
                StyleExpr = g_ColorFront;
            }
            field("Market View Cost(HKD)";"Market View Cost(HKD)")
            {
                ApplicationArea = Basic;
                Caption = 'Market View Cost (HKD)';
                Editable = false;
                StyleExpr = g_ColorFront;
            }
            field(CalcGP;CalcGP)
            {
                ApplicationArea = Basic;
                Caption = 'GP %';
                Editable = false;
                StyleExpr = g_ColorFront;
                Visible = false;
            }
            field(CalcStockTurn;CalcStockTurn)
            {
                ApplicationArea = Basic;
                Caption = 'Stock Turn';
                Editable = false;
                StyleExpr = g_ColorFront;
            }
            field(GetItemClass;GetItemClass)
            {
                ApplicationArea = Basic;
                Caption = 'Item Class';
                StyleExpr = g_ColorFront;
            }
        }
        addafter(Description)
        {
            field(Net;Net)
            {
                ApplicationArea = Basic;
                Editable = true;
                StyleExpr = g_ColorFront;
            }
        }
        addafter("Direct Unit Cost")
        {
            field("Market View Cost";"Market View Cost")
            {
                ApplicationArea = Basic;
                StyleExpr = g_ColorFront;
            }
            field("Tolerance Cost";"Tolerance Cost")
            {
                ApplicationArea = Basic;
                StyleExpr = g_ColorFront;
            }
            field("Tolerance Cost - Min";"Tolerance Cost - Min")
            {
                ApplicationArea = Basic;
                Editable = false;
                StyleExpr = g_ColorFront;
                Visible = g_booLL;
            }
        }
        addafter(RefreshTotals)
        {
            field("Total Item Qty";TotalItemQty)
            {
                ApplicationArea = Basic;
                Editable = false;
            }
        }
    }

    var
        g_decAvgCost: Decimal;

    var
        TotalItemQty: Integer;
        l_rePurchLine: Record "Purchase Line";
        g_decAvgCost: Decimal;
        g_decGP: Decimal;
        g_decStockTurn: Decimal;
        g_decPendOrderQty: Decimal;
        g_codItemClass: Text[30];
        g_booLL: Boolean;
        g_booRES: Boolean;
        g_booWRExist: Boolean;
        g_booPWRExist: Boolean;
        g_booReopen: Boolean;
        g_recVendor: Record Vendor;
        g_recWRLine: Record "Warehouse Receipt Line";
        g_recPWRLine: Record "Posted Whse. Shipment Line";
        LLMSCode: Code[40];
        g_ColorFront: Text;
        Item: Record Item;
        g_recItem: Record Item;
        WhseValidateSourceLine: Codeunit "Whse. Validate Source Line";


    //Unsupported feature: Code Modification on "OnAfterGetCurrRecord".

    //trigger OnAfterGetCurrRecord()
    //>>>> ORIGINAL CODE:
    //begin
        /*
        IF PurchHeader.GET("Document Type","Document No.") THEN;

        DocumentTotals.PurchaseUpdateTotalsControls(Rec,TotalPurchaseHeader,TotalPurchaseLine,RefreshMessageEnabled,
          TotalAmountStyle,RefreshMessageText,InvDiscAmountEditable,VATAmount);
        */
    //end;
    //>>>> MODIFIED CODE:
    //begin
        /*
        // FC-2: Added by Jacky on 24/12/2015 for Purchase/Fin
        CLEAR(TotalItemQty);
        l_rePurchLine.RESET;
        l_rePurchLine.SETRANGE("Document No.", "Document No.");
        IF l_rePurchLine.FINDSET THEN  BEGIN
        REPEAT
          IF l_rePurchLine.Type= l_rePurchLine.Type::Item THEN BEGIN
            TotalItemQty:= TotalItemQty + l_rePurchLine.Quantity;
          END;
        UNTIL l_rePurchLine.NEXT = 0;
        END;

        #1..4

        //#001 <<
        //g_decAvgCost := CalcAvgCost;
        {
        IF CalcAvgSalesPrice <> 0 THEN
          g_decGP := 1 - g_decAvgCost / CalcAvgSalesPrice
        ELSE
          g_decGP := 0;
        }
        //g_decStockTurn := CalcStockTurn;
        //g_decPendOrderQty := CalcPendOrderQty;
        //g_codItemClass := GetItemClass;
        //#001 >>
        */
    //end;


    //Unsupported feature: Code Insertion (VariableCollection) on "OnAfterGetRecord".

    //trigger (Variable: g_decAvgCost)()
    //Parameters and return type have not been exported.
    //begin
        /*
        */
    //end;


    //Unsupported feature: Code Modification on "OnAfterGetRecord".

    //trigger OnAfterGetRecord()
    //>>>> ORIGINAL CODE:
    //begin
        /*
        ShowShortcutDimCode(ShortcutDimCode);
        TypeChosen := HasTypeToFillMandatotyFields;
        CLEAR(DocumentTotals);
        */
    //end;
    //>>>> MODIFIED CODE:
    //begin
        /*
        ShowShortcutDimCode(ShortcutDimCode);
        TypeChosen := Type <> Type::" ";



        //#001 <<
        //g_decAvgCost := CalcAvgCost;
        {
        IF CalcAvgSalesPrice <> 0 THEN
          g_decGP := 1 - g_decAvgCost / CalcAvgSalesPrice
        ELSE
          g_decGP := 0;
        }
        //g_decStockTurn := CalcStockTurn;
        //g_decPendOrderQty := CalcPendOrderQty;
        //g_codItemClass := GetItemClass;
        //#001 >>
        //#006<<
        //GetCostTolerance(3);  #008-
        g_ColorFront:=GetStyleText("Direct Unit Cost");

        //#006>>

        // #009 <<
        g_booRES := FALSE;
        g_booWRExist := FALSE;
        g_booPWRExist := FALSE;
        g_booReopen := FALSE;

        g_recVendor.RESET;
        g_recVendor.SETRANGE("No.", "Buy-from Vendor No.");
        g_recVendor.SETRANGE("RES Item Allowed", TRUE);
        IF g_recVendor.FINDSET = TRUE THEN
        BEGIN
          g_booRES := TRUE;
        END;

        g_recWRLine.RESET;
        g_recWRLine.SETRANGE("Source No.","Document No.");
        IF g_recWRLine.FINDSET = TRUE THEN
        BEGIN
          g_booWRExist := TRUE;
        END;

        g_recPWRLine.RESET;
        g_recPWRLine.SETRANGE("Source No.","Document No.");
        IF g_recPWRLine.FINDSET = TRUE THEN
        BEGIN
          g_booPWRExist := TRUE;
        END;

        IF PurchHeader."Reopen By" = '' THEN
        BEGIN
          g_booReopen := TRUE;
        END;
        // #009 >>

        //#010<<
        IF ("Market View Cost(HKD)"=0) AND ("Market Cost Updated"=FALSE)  THEN
        BEGIN
           GetCostTolerance(3);//#023

          IF "Market View Cost(HKD)"<>0 THEN
          MODIFY(FALSE);
        END;
        //#010>>
        */
    //end;


    //Unsupported feature: Code Modification on "OnDeleteRecord".

    //trigger OnDeleteRecord(): Boolean
    //>>>> ORIGINAL CODE:
    //begin
        /*
        IF (Quantity <> 0) AND ItemExists("No.") THEN BEGIN
          COMMIT;
          IF NOT ReservePurchLine.DeleteLineConfirm(Rec) THEN
            EXIT(FALSE);
          ReservePurchLine.DeleteLine(Rec);
        END;
        */
    //end;
    //>>>> MODIFIED CODE:
    //begin
        /*
        #1..5


          TESTFIELD("Quantity Received",0)//#007+
        END;
        */
    //end;


    //Unsupported feature: Code Insertion on "OnOpenPage".

    //trigger OnOpenPage()
    //begin
        /*

        // #002 <<
        g_booLL := FALSE;
        IF (COMPANYNAME = 'Lens Labo') THEN BEGIN
          g_booLL := TRUE;
        END;
        // #002 >>
        */
    //end;

    local procedure _CM_()
    begin
    end;

    local procedure CalcAvgCost_delete(): Decimal
    var
        l_recItem: Record Item;
        l_recValueEntry: Record "Value Entry";
        l_decQty: Decimal;
        l_decTotalAmt: Decimal;
    begin
        //#001 <<
        //#006 copy to table
        l_decQty := 0;
        l_decTotalAmt := 0;

        if l_recItem.Get("No.") then
        begin


          l_recValueEntry.Reset;
          l_recValueEntry.SetRange("Item No.", "No.");
          l_recValueEntry.SetRange("Posting Date", CalcDate('<-179D>', Today), Today);
          l_recValueEntry.SetRange("Document Type", l_recValueEntry."document type"::"Purchase Invoice");
          l_recValueEntry.SetRange("Location Code", "Location Code");
          if l_recValueEntry.FindSet then
          repeat
            l_decQty += l_recValueEntry."Valued Quantity";
            l_decTotalAmt += l_recValueEntry."Purchase Amount (Actual)";
          until l_recValueEntry.Next = 0;

        end;

        if l_decQty <> 0 then
          exit (l_decTotalAmt/l_decQty)
        else
          exit (0);

        //#001 >>
    end;

    local procedure CalcAvgSalesPrice(): Decimal
    var
        l_recItem: Record Item;
        l_recValueEntry: Record "Value Entry";
        l_decQty: Decimal;
        l_decTotalAmt: Decimal;
    begin
        //#001 <<
        l_decQty := 0;
        l_decTotalAmt := 0;

        if l_recItem.Get("No.") then
        begin


          l_recValueEntry.Reset;
          l_recValueEntry.SetRange("Item No.", "No.");
          l_recValueEntry.SetRange("Posting Date", CalcDate('<-179D>', Today), Today);
          l_recValueEntry.SetRange("Document Type", l_recValueEntry."document type"::"Sales Invoice");
          l_recValueEntry.SetRange("Location Code", "Location Code");
          if l_recValueEntry.FindSet then
          repeat
            l_decQty += l_recValueEntry."Valued Quantity";
            l_decTotalAmt += l_recValueEntry."Sales Amount (Actual)";
          until l_recValueEntry.Next = 0;

        end;

        if l_decQty <> 0 then
          exit (l_decTotalAmt/ -(l_decQty))
        else
          exit (0);
        //#001 >>
    end;

    local procedure CalcStockTurn(): Decimal
    var
        l_recItem: Record Item;
        l_recILE: Record "Item Ledger Entry";
        l_decQty: Decimal;
        l_decTotalAmt: Decimal;
    begin
        //#001 <<
        l_decQty := 0;
        l_decTotalAmt := 0;

        if l_recItem.Get("No.") then
        begin

          l_recItem.SetFilter("Location Filter", "Location Code");
          l_recItem.CalcFields(Inventory);


          l_recILE.Reset;
          l_recILE.SetRange("Item No.", "No.");
          l_recILE.SetRange("Posting Date", CalcDate('<-179D>', Today), Today);
          l_recILE.SetRange("Entry Type", l_recILE."entry type"::Sale);
          l_recILE.SetRange("Location Code", "Location Code");
          if l_recILE.FindSet then
          repeat
            l_decQty += -l_recILE.Quantity;
          until l_recILE.Next = 0;


        end;

        if l_recItem.Inventory <> 0 then
          exit (l_decQty/l_recItem.Inventory)
        else
          exit (0);
        //#001 >>
    end;

    local procedure CalcPendOrderQty(): Decimal
    var
        l_recItem: Record Item;
        l_recPurchLine: Record "Purchase Line";
        l_decQty: Decimal;
        l_decTotalAmt: Decimal;
    begin
        //#001 <<
        l_decQty := 0;

        if l_recItem.Get("No.") then
        begin


          l_recPurchLine.Reset;
          l_recPurchLine.SetRange("No.", "No.");
          l_recPurchLine.SetRange("Document Type", l_recPurchLine."document type"::Order);
          l_recPurchLine.SetRange("Location Code", "Location Code");
          if l_recPurchLine.FindSet then
          repeat
            l_decQty += l_recPurchLine."Outstanding Quantity";
          until l_recPurchLine.Next = 0;

        end;

        if l_decQty <> 0 then
          exit (l_decQty)
        else
          exit (0);

        //#001 >>
    end;

    local procedure GetItemClass(): Text
    var
        l_recItemClass: Record ITEM_CLASS;
    begin
        l_recItemClass.Reset;
        l_recItemClass.SetRange(l_recItemClass.ITEM_CODE, "No.");
        if l_recItemClass.FindFirst then
          exit(l_recItemClass.ITEM_CLASS)
        else
          exit('');
    end;

    local procedure CalcGP(): Decimal
    var
        l: Record Item;
        l_recValueEntry: Record "Value Entry";
        l_decQty: Decimal;
        l_decTotalAmt: Decimal;
        l_decSalesInvAmt: Decimal;
    begin
        if CalcAvgSalesPrice <> 0 then
          exit(1 - CalcAvgCost / CalcAvgSalesPrice)
        else
          exit(0);
    end;

    procedure CalLastPurchasePrice(var SourcePOLine: Record "Purchase Line";ExternalCall: Boolean)
    var
        LastPOLine: Record "Purchase Line";
        POHeader: Record "Purchase Header";
        Found: Boolean;
        InvSetup: Record "Inventory Setup";
    begin
        //CalLastPurchasePrice
        //#003->
        if (POHeader.Get(SourcePOLine."Document Type",SourcePOLine."Document No.")) and (POHeader."Is Dummy") then
            exit;

        if  (SourcePOLine.Type = SourcePOLine.Type::Item) and (SourcePOLine."No." <> '') and
            (InvSetup.Get) and (InvSetup."Dummy Item No." <> SourcePOLine."No.")then begin
                Clear(LastPOLine);
                //default sorting (Document Type,Document No.,Line No.)
                LastPOLine.SetRange("Document Type",LastPOLine."document type"::Order);
                LastPOLine.SetRange("Buy-from Vendor No.",SourcePOLine."Buy-from Vendor No.");
                LastPOLine.SetRange(Type,LastPOLine.Type::Item);
                LastPOLine.SetRange("No.",SourcePOLine."No.");
                LastPOLine.SetRange("Currency Code",SourcePOLine."Currency Code");
                LastPOLine.SetFilter("Quantity Invoiced",'>%1',0);
                LastPOLine.SetFilter(Quantity,'>%1',0);
                LastPOLine.SetFilter("Document No.",'<%1',SourcePOLine."Document No.");
                if LastPOLine.FindLast then begin
                    repeat
                        if POHeader.Get(LastPOLine."Document Type",LastPOLine."Document No.") and (not POHeader."Is Dummy") then begin
                            SourcePOLine."Last Stock-in Cost" := LastPOLine."Direct Unit Cost";
                            Found := true;

                            if (not ExternalCall) and (xRec."No." <> '') then
                                CurrPage.SaveRecord;

                        end;
                    until (LastPOLine.Next = 0) or (Found)
                end else begin
                    SourcePOLine."Last Stock-in Cost" := 0;
                end;
        end else begin
            SourcePOLine."Last Stock-in Cost" := 0;
        end;
        //#003<-
    end;

    procedure GetStyleText(fieldvalue: Decimal): Text
    begin
        PurchHeader.Get("Document Type","Document No.");
        if PurchHeader.Status in [PurchHeader.Status::"Pending Approval" ,PurchHeader.Status::Released] then
         exit('');
        //IF "Last Unit Cost"=0 THEN
        //  EXIT('');
        if Type<>Type::Item then
         exit('');
        if not Item.Get("No.") then
         exit('');
        
        //#008 ->
        /*
        //IF (fieldvalue<>0)  AND ( fieldvalue>"Tolerance Cost")                           AND ( COPYSTR("No.",1,3)<>'DUM' ) AND (Item."Item Type"<>Item."Item Type"::Mini)  THEN
        IF NeedCostApproval THEN
        IF fieldvalue> "Tolerance Cost" THEN
          EXIT('Unfavorable')
        ELSE
          EXIT('');
        */
        
        if NeedCostApproval then begin
            if fieldvalue> "Tolerance Cost" then begin
                exit('Unfavorable');
            end else if ("Tolerance Cost - Min" <> 0) and (fieldvalue < "Tolerance Cost - Min") then begin
                exit('Unfavorable');
            end;
        end else begin
            exit('');
        end;
        //#008 <-

    end;

    local procedure RESValidate()
    begin
        // #009 <<
        if (PurchHeader."Reopen By" <> '' ) and (g_booRES = false) and (g_booWRExist = false) and (g_booPWRExist = false) then
        begin
          if xRec."No." <> Rec."No." then
          begin
             g_recItem.Reset;
             g_recItem.SetRange("No.", Rec."No.");
             g_recItem.SetRange(Restricted, true);
             if not g_recItem.IsEmpty  then
             begin
                Error('%1 is restricted item, can not input', Rec."No.");
                CurrPage.Update(false);
             end;
          end else begin
             g_recItem.Reset;
             g_recItem.SetRange("No.", xRec."No.");
             g_recItem.SetRange(Restricted, true);
             if not g_recItem.IsEmpty  then
             begin
                if xRec.Quantity <> Rec.Quantity then
                begin
                   Error('%1 is restricted item, should not change - Quantity', Rec."No.");
                   CurrPage.Update(false);
                end;
                if xRec."Direct Unit Cost" <> Rec."Direct Unit Cost" then
                begin
                   Error('%1 is restricted item, should not change - Unit Cost', Rec."No.");
                   CurrPage.Update(false);
                end;
                if xRec."Location Code" <> Rec."Location Code" then
                begin
                   Error('%1 is restricted item, should not change - Location Code', Rec."No.");
                   CurrPage.Update(false);
                end;
              end;
           end;
        end else begin
            if (PurchHeader."Reopen By" = '' ) and (g_booRES = false) and (g_booWRExist = false) and (g_booPWRExist = false) then
            begin
              g_recItem.Reset;
              g_recItem.SetRange("No.", Rec."No.");
              g_recItem.SetRange(Restricted, true);
              if not g_recItem.IsEmpty  then
              begin
                 Error('%1 is restricted item, can not input', Rec."No.");
                 CurrPage.Update(false);
              end;
            end;
        end;
        // #009 >>
        //
    end;
}

